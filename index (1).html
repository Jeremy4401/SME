
<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='UTF-8'>
<title>SME Platform - FULL SYSTEM</title>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>

<style>
/* GLOBAL THEME */
@font-face { font-family: "Comic Sans MS"; src: local("Comic Sans MS"); }
:root {
  --bg:#0f0f0f; --bg2:#1a1a1a; --text:#fff; --accent:#4caf50;
  --sidebar:#000; --banner1:#000; --banner2:#0f0f0f;
}
body {
  margin:0; background:var(--bg); color:var(--text);
  font-family:"Comic Sans MS"; overflow-x:hidden;
}

/* ANIMATED BACKGROUND */
body::before {
  content:""; position:fixed; inset:0; z-index:-1;
  background:linear-gradient(130deg,#000,#0c0c0c,#111);
  background-size:240% 240%;
  animation:bgwave 14s infinite ease;
}
@keyframes bgwave {
  0%{background-position:0% 50%;}
 50%{background-position:100% 50%;}
100%{background-position:0% 50%;}
}

/* SIDEBAR */
#sidebar {
  position:fixed; top:0; left:0; width:75px; height:100%;
  background:var(--sidebar); padding-top:20px;
  display:flex; flex-direction:column; gap:10px;
}
#sidebar div {
  padding:15px; cursor:pointer; text-align:center; font-size:24px;
  transition:.2s;
}
#sidebar div:hover { transform:scale(1.2); }

/* MAIN AREA */
#main { margin-left:90px; padding:20px; }

/* SECTION */
.section { display:none; }
.section.active { display:block; }

/* BANNER PROFILE HEADER (Style B - Soft Black Gradient) */
.profileBanner {
  background:linear-gradient(to bottom, var(--banner1), var(--banner2));
  height:160px; border-radius:12px; margin-bottom:20px;
  position:relative;
}
.profileAvatar {
  width:110px; height:110px; border-radius:50%;
  position:absolute; bottom:-40px; left:20px;
  border:4px solid var(--accent); object-fit:cover;
}

/* GENERIC CARDS */
.card {
  background:var(--bg2); width:180px; border-radius:12px;
  padding:12px; display:inline-block; margin:8px;
  cursor:pointer; transition:.2s;
}
.card:hover { transform:translateY(-6px) scale(1.05); }
.card img { width:100%; border-radius:10px; }

/* FAVORITE STAR */
.star {
  position:absolute; top:8px; left:8px;
  font-size:20px; cursor:pointer; color:#777;
}
.star.fav { color:gold; text-shadow:0 0 10px gold; }

/* EMBED */
#embedWin {
  display:none; position:fixed; inset:0; background:#000d; z-index:9999;
}
#embedWin iframe { width:100%; height:100%; border:none; }
</style>
</head>
<body>

<div id='sidebar'>
  <div onclick="nav('games')">üéÆ</div>
  <div onclick="nav('downloads')">‚¨á</div>
  <div onclick="nav('favorites')">‚≠ê</div>
  <div onclick="nav('friends')">üë•</div>
  <div onclick="nav('profile')">üë§</div>
  <div onclick="toggleTheme()">üåó</div>
  <div onclick="panic()">‚ö†</div>
</div>

<div id='main'>

<h1 id='pageTitle'>SME Platform</h1>

<!-- Sections will be filled in later steps -->

<div id='games' class='section active'></div>
<div id='downloads' class='section'></div>
<div id='favorites' class='section'></div>
<div id='friends' class='section'></div>
<div id='profile' class='section'></div>

</div>

<div id='embedWin'><iframe id='embedFrame'></iframe></div>

<script>
function nav(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById('pageTitle').textContent = id.charAt(0).toUpperCase()+id.slice(1);
}
function toggleTheme(){ document.body.classList.toggle('light'); }
function panic(){ location.href="https://classroom.google.com"; }

const uv="https://holyubofficial.net/service/";
function enc(u){ return uv + btoa(u).replace(/=/g,""); }

let favorites = JSON.parse(localStorage.getItem('favorites')||"[]");
let profile = JSON.parse(localStorage.getItem('profile')||"{}");
let friends = JSON.parse(localStorage.getItem('friends')||"[]");
let requests = JSON.parse(localStorage.getItem('requests')||"[]");
let friendCode = "USER" + Math.floor(Math.random()*99999);


/* ===========================
   STEP 2 - GAME SYSTEM
========================== */

let games = [
  {name:"Slime Rancher", img:"thumb1.png", url:"https://jeremy4401.github.io/slime-rancher/", cat:"Action"},
  {name:"Minecraft Classic", img:"thumb2.png", url:"https://classic.minecraft.net/", cat:"Survival"},
  {name:"Buckshot Roulette", img:"thumb3.png", url:"https://cdn.jsdelivr.net/gh/genizy/web-port@main/buckshot-roulette/index.html", cat:"Horror"}
];

/* Load Games */
function renderGames(){
  let html = "<h1>Games</h1>";
  games.forEach(g=>{
    let fav = favorites.includes(g.name) ? "fav" : "";
    html += `
    <div class='card' onclick="play(enc('${g.url}'))" style="position:relative;">
      <div class="star ${fav}" onclick="toggleFav('${g.name}'); event.stopPropagation();">‚òÖ</div>
      <img src="${g.img}">
      <button>${g.name}</button>
    </div>`;
  });
  document.getElementById('games').innerHTML = html;
}

/* Favorites */
function toggleFav(name){
  if(favorites.includes(name)) favorites = favorites.filter(f=>f!==name);
  else favorites.push(name);
  localStorage.setItem('favorites', JSON.stringify(favorites));
  renderGames(); renderFavs();
}

function renderFavs(){
  let html = "<h1>Favorites</h1>";
  favorites.forEach(f=>{
    let g = games.find(x=>x.name===f);
    if(g){
      html += `
      <div class='card' onclick="play(enc('${g.url}'))">
        <img src="${g.img}">
        <button>${g.name}</button>
      </div>`;
    }
  });
  document.getElementById('favorites').innerHTML = html;
}

/* Game Embed */
function play(url){
  document.getElementById('embedWin').style.display='block';
  document.getElementById('embedFrame').src = url;
}
document.addEventListener('keydown', e=>{
  if(e.key==="Escape"){
    document.getElementById('embedWin').style.display='none';
    document.getElementById('embedFrame').src="";
  }
});

/* Initialize Step 2 */
renderGames();
renderFavs();


/* ===========================
   STEP 3 - FRIEND SYSTEM
=========================== */

/* Render Friends Section */
function renderFriends(){
  let html = `
    <h1>Friends</h1>
    <h3>Your Friend Code:</h3>
    <div style='background:#222;padding:10px;border-radius:8px;margin-bottom:15px;'>
      ${friendCode}
    </div>

    <h3>Friend Requests</h3>
    <div id='reqList'></div>

    <h3>Your Friends</h3>
    <div id='friendList'></div>

    <h3>Add Friend</h3>
    <input id='addFriendCode' placeholder='Enter friend code' style='padding:8px;border-radius:8px;border:none;background:#222;color:white;'>
    <button onclick='sendFriendRequest()' style='padding:8px;border:none;border-radius:6px;background:#4caf50;color:white;margin-left:6px;'>Add</button>

    <h3>Friend Profile</h3>
    <div id='friendProfile' style='display:none;'></div>
  `;
  document.getElementById('friends').innerHTML = html;
  loadRequests();
  loadFriends();
}
renderFriends();

/* Send Friend Request */
function sendFriendRequest(){
  let code = document.getElementById('addFriendCode').value.trim();
  if(!code) return alert("Enter a code.");
  if(code === friendCode) return alert("You cannot add yourself.");

  requests.push({from:code});
  saveSocial();
  loadRequests();
  alert("Friend request sent!");
}

/* Load Friend Requests */
function loadRequests(){
  let html = "";
  requests.forEach(r=>{
    html += `
      <div class='reqCard'>
        Request from ${r.from}<br>
        <button onclick="acceptReq('${r.from}')">Accept</button>
        <button onclick="declineReq('${r.from}')">Decline</button>
      </div>`;
  });
  document.getElementById('reqList').innerHTML = html;
}

/* Accept / Decline */
function acceptReq(code){
  if(!friends.includes(code)) friends.push(code);
  requests = requests.filter(r=>r.from !== code);
  saveSocial();
  loadRequests();
  loadFriends();
}
function declineReq(code){
  requests = requests.filter(r=>r.from !== code);
  saveSocial();
  loadRequests();
}

/* Load Friends */
function loadFriends(){
  let html = "";
  friends.forEach(code=>{
    html += `
      <div class='friendCard' onclick="openFriend('${code}')">
        <b>${code}</b><br>Status: Online
      </div>`;
  });
  document.getElementById('friendList').innerHTML = html;
}

/* Friend Profile (Style B) */
function openFriend(code){
  document.getElementById('friendProfile').style.display = 'block';
  document.getElementById('friendProfile').innerHTML = `
    <div class='profileBanner'></div>
    <img class='profileAvatar' src='https://i.imgur.com/1X5Rz.png'>
    <div style='margin-left:150px;margin-top:10px;'>
      <h2>${code}</h2>
      <p>Status: Online</p>
      <p>Friend since: Today</p>
      <button onclick="removeFriend('${code}')" style='padding:8px;border:none;border-radius:6px;background:#c0392b;color:white;'>Remove Friend</button>
    </div>
  `;
}

/* Remove friend */
function removeFriend(code){
  friends = friends.filter(f=>f!==code);
  saveSocial();
  loadFriends();
  document.getElementById('friendProfile').style.display='none';
}

/* Save social data */
function saveSocial(){
  localStorage.setItem('friends',JSON.stringify(friends));
  localStorage.setItem('requests',JSON.stringify(requests));
}


/* ===========================
   STEP 4 - PROFILE SYSTEM
=========================== */

function renderProfile(){
  let html = `
    <h1>Your Profile</h1>
    <div class='profileBanner'></div>
    <img class='profileAvatar' id='userAvatar' src='${profile.avatar || "https://i.imgur.com/1X5Rz.png"}'>
    <div style='margin-left:150px;margin-top:10px;'>
      <h2 id='usernameDisplay'>${profile.username || "Player"}</h2>
      <p>Status: <span id='statusDisplay'>${profile.status || "Online"}</span></p>
      <p>Bio: ${profile.bio || "No bio set."}</p>

      <h3>Edit Profile</h3>
      <input id='usernameInput' placeholder='Username' value='${profile.username || ""}'><br><br>
      <textarea id='bioInput' placeholder='Bio...'>${profile.bio || ""}</textarea><br><br>
      <select id='statusInput'>
        <option ${profile.status==="Online"?"selected":""}>Online</option>
        <option ${profile.status==="Busy"?"selected":""}>Busy</option>
        <option ${profile.status==="Offline"?"selected":""}>Offline</option>
      </select><br><br>
      <input id='avatarInput' placeholder='Avatar image URL' value='${profile.avatar || ""}'><br><br>

      <button onclick='saveProfileFull()' style='padding:10px;border:none;background:#4caf50;color:white;border-radius:6px;'>Save</button>
    </div>
  `;
  document.getElementById('profile').innerHTML = html;
}
renderProfile();

function saveProfileFull(){
  profile.username = document.getElementById('usernameInput').value;
  profile.bio = document.getElementById('bioInput').value;
  profile.status = document.getElementById('statusInput').value;
  profile.avatar = document.getElementById('avatarInput').value;

  localStorage.setItem('profile', JSON.stringify(profile));
  renderProfile();
  alert("Profile updated!");
}


/* ===========================
   STEP 5 - FINAL POLISH SYSTEMS
=========================== */

/* Recently Played */
let recent = JSON.parse(localStorage.getItem('recent')||"[]");
function addRecent(name){
  recent = recent.filter(r=>r!==name);
  recent.unshift(name);
  if(recent.length>10) recent.pop();
  localStorage.setItem('recent',JSON.stringify(recent));
}
function renderRecent(){
  let html = "<h1>Recently Played</h1>";
  recent.forEach(r=>{
    let g = games.find(x=>x.name===r);
    if(g){
      html += `
      <div class='card' onclick="play(enc('${g.url}')); addRecent('${r}')">
        <img src="${g.img}">
        <button>${g.name}</button>
      </div>`;
    }
  });
  let sec = document.createElement("div");
  sec.innerHTML = html;
  document.getElementById("games").prepend(sec);
}

/* Override play function to track recents */
const oldPlay = play;
play = function(url){
  let g = games.find(x=>enc(x.url)===url);
  if(g) addRecent(g.name);
  oldPlay(url);
};

/* Categories */
function renderCategories(){
  let cats = [...new Set(games.map(g=>g.cat))];
  let html = "<h3>Categories:</h3>";
  cats.forEach(c=>{
    html += `<button onclick="filterCat('${c}')" style='margin:5px;padding:6px;border-radius:6px;background:#333;color:white;border:none;'>${c}</button>`;
  });
  html += `<button onclick="renderGames(); renderRecent()" style='margin:5px;padding:6px;border-radius:6px;background:#4caf50;color:white;border:none;'>All</button>`;
  document.getElementById('games').innerHTML = html + document.getElementById('games').innerHTML;
}
function filterCat(c){
  let html = "<h1>Games</h1>";
  games.filter(g=>g.cat===c).forEach(g=>{
    let fav = favorites.includes(g.name) ? "fav" : "";
    html += `
    <div class='card' onclick="play(enc('${g.url}')); addRecent('${g.name}')" style="position:relative;">
      <div class="star ${fav}" onclick="toggleFav('${g.name}'); event.stopPropagation();">‚òÖ</div>
      <img src="${g.img}">
      <button>${g.name}</button>
    </div>`;
  });
  document.getElementById('games').innerHTML = html;
}

/* Activity Feed (basic placeholder) */
function renderActivity(){
  let html = "<h1>Activity Feed</h1><p>(Activity tracking placeholder)</p>";
  let sec = document.createElement("div");
  sec.innerHTML=html;
  document.getElementById('friends').append(sec);
}

/* Initialize Step 5 */
renderRecent();
renderCategories();
renderActivity();


/* ===========================
   PHASE 1 - MESSAGING SYSTEM
=========================== */

let messages = JSON.parse(localStorage.getItem('messages') || "{}");

/* Open chat with friend */
function openChat(code){
  if(!messages[code]) messages[code] = [];
  renderChat(code);
}

/* Render chat window */
function renderChat(code){
  let chatHTML = `
    <h2>Chat with ${code}</h2>
    <div id='chatBox' style='height:300px;overflow-y:auto;background:#1a1a1a;padding:10px;border-radius:10px;margin-bottom:10px;'>
  `;

  messages[code].forEach(m=>{
    chatHTML += `
      <div style='margin:8px 0;padding:8px;background:#333;border-radius:8px;'>
        <b>${m.from}:</b> ${m.text} <br>
        <span style='font-size:10px;color:#aaa;'>${m.time}</span>
      </div>`;
  });

  chatHTML += `</div>
    <input id='chatInput' placeholder='Type message...' style='width:80%;padding:8px;border:none;border-radius:8px;background:#333;color:white;'>
    <button onclick="sendMessage('${code}')" style='padding:8px;border:none;border-radius:8px;background:#4caf50;color:white;'>Send</button>
  `;

  document.getElementById('friendProfile').style.display='block';
  document.getElementById('friendProfile').innerHTML = chatHTML;
}

/* Send message */
function sendMessage(code){
  let text = document.getElementById('chatInput').value;
  if(!text) return;

  let entry = {
    from: profile.username || "You",
    text: text,
    time: new Date().toLocaleTimeString()
  };

  messages[code].push(entry);
  localStorage.setItem('messages', JSON.stringify(messages));
  renderChat(code);
}


/* ===========================
   PHASE 2 - ACTIVITY FEED SYSTEM
=========================== */

let activity = JSON.parse(localStorage.getItem('activity') || "[]");

/* Log activity */
function logActivity(type, detail){
  let entry = {
    type: type,
    detail: detail,
    time: new Date().toLocaleString()
  };
  activity.unshift(entry);
  if(activity.length > 50) activity.pop();
  localStorage.setItem('activity', JSON.stringify(activity));
}

/* Log game launch */
const oldPlayFunc = play;
play = function(url){
  let gameObj = games.find(g => enc(g.url) === url);
  if(gameObj){
    logActivity("Game Launched", gameObj.name);
  }
  oldPlayFunc(url);
};

/* Render Global Activity Feed */
function renderActivityFeed(){
  let html = "<h1>Activity Feed</h1>";
  activity.forEach(a=>{
    html += `
      <div style='background:#222;padding:10px;margin:8px;border-radius:10px;'>
        <b>${a.type}:</b> ${a.detail}<br>
        <span style='font-size:10px;color:#aaa;'>${a.time}</span>
      </div>
    `;
  });
  // Append to friends page
  let node = document.createElement("div");
  node.innerHTML = html;
  document.getElementById("friends").append(node);
}

/* Friend Profile Activity */
function renderFriendActivity(code){
  let html = "<h3>Activity</h3>";
  activity.filter(a=>a.detail.includes(code)).forEach(a=>{
    html += `
      <div style='background:#333;padding:8px;border-radius:8px;margin:5px 0;'>
        ${a.detail} <br>
        <span style='font-size:10px;color:#777;'>${a.time}</span>
      </div>`;
  });
  return html;
}

/* Inject into Friend Profile */
const oldOpenFriend = openFriend;
openFriend = function(code){
  oldOpenFriend(code);
  document.getElementById('friendProfile').innerHTML += renderFriendActivity(code);
};

/* Initialize Activity Feed */
renderActivityFeed();


/* ===========================
   PHASE 3 - FRIEND PROFILE TABS
=========================== */

/* Render tab buttons + container */
function openFriend(code){
  // Base profile (existing)
  let banner = `
    <div class='profileBanner'></div>
    <img class='profileAvatar' src='https://i.imgur.com/1X5Rz.png'>
    <div style='margin-left:150px;margin-top:10px;'>
      <h2>${code}</h2>
      <p>Status: Online</p>
      <p>Friend since: Today</p>
      <button onclick="removeFriend('${code}')" 
        style='padding:8px;border:none;border-radius:6px;background:#c0392b;color:white;'>Remove Friend</button>
    </div>
  `;

  let tabs = `
    <div style='margin-top:20px;display:flex;gap:10px;'>
      <button class='tabBtn' onclick="switchTab('${code}','overview')">Overview</button>
      <button class='tabBtn' onclick="switchTab('${code}','activity')">Activity</button>
      <button class='tabBtn' onclick="switchTab('${code}','recent')">Recent Games</button>
      <button class='tabBtn' onclick="switchTab('${code}','mutual')">Mutual Favorites</button>
    </div>
  `;

  document.getElementById('friendProfile').style.display = 'block';
  document.getElementById('friendProfile').innerHTML = banner + tabs + 
    `<div id='friendTabContent' style='margin-top:20px;'></div>`;

  switchTab(code, 'overview');
}

/* Switch tabs */
function switchTab(code, tab){
  let box = document.getElementById('friendTabContent');

  if(tab === 'overview'){
    box.innerHTML = "<p>This is your friend's overview section.</p>";
  }

  if(tab === 'activity'){
    let html = "<h3>Activity</h3>";
    activity.forEach(a=>{
      if(a.detail.includes(code)){
        html += `
          <div style='background:#222;padding:10px;border-radius:10px;margin:5px 0;'>
            <b>${a.type}</b>: ${a.detail}<br>
            <span style='font-size:10px;color:#aaa;'>${a.time}</span>
          </div>
        `;
      }
    });
    box.innerHTML = html;
  }

  if(tab === 'recent'){
    let html = "<h3>Recent Games</h3>";
    recent.forEach(r=>{
      let g = games.find(x=>x.name===r);
      if(g){
        html += `
          <div class='card' onclick="play(enc('${g.url}'))">
            <img src="${g.img}">
            <button>${g.name}</button>
          </div>`;
      }
    });
    box.innerHTML = html;
  }

  if(tab === 'mutual'){
    let html = "<h3>Mutual Favorites</h3>";
    favorites.forEach(f=>{
      let g = games.find(x=>x.name===f);
      if(g){
        html += `
          <div class='card'>
            <img src="${g.img}">
            <button>${g.name}</button>
          </div>`;
      }
    });
    box.innerHTML = html || "<p>No mutual favorites found.</p>";
  }
}


/* ===========================
   PHASE 4 - XP + ACHIEVEMENTS SYSTEM
=========================== */

let xpData = JSON.parse(localStorage.getItem('xpData') || '{"xp":0,"level":1,"achievements":[]}');

/* Gain XP when launching a game */
function gainXP(amount){
  xpData.xp += amount;

  /* Level Up every 100 XP */
  while(xpData.xp >= xpData.level * 100){
    xpData.xp -= xpData.level * 100;
    xpData.level++;
    unlockAchievement("Level Up " + xpData.level);
  }

  saveXP();
  updateProfileXP();
}

/* Wrap play() to include XP gain */
const oldPlayV2 = play;
play = function(url){
  let gameObj = games.find(g => enc(g.url) === url);
  if(gameObj){
    logActivity("Played Game", gameObj.name);
    gainXP(20);  // +20 XP per game launch
  }
  oldPlayV2(url);
};

/* Achievements */
function unlockAchievement(name){
  if(!xpData.achievements.includes(name)){
    xpData.achievements.push(name);
    showAchievementPopup(name);
    saveXP();
  }
}

/* Popup message */
function showAchievementPopup(name){
  let div = document.createElement("div");
  div.style.position = "fixed";
  div.style.bottom = "20px";
  div.style.right = "20px";
  div.style.background = "#4caf50";
  div.style.padding = "12px 20px";
  div.style.borderRadius = "10px";
  div.style.color = "white";
  div.style.fontSize = "16px";
  div.style.boxShadow = "0 0 15px #000";
  div.innerHTML = "üèÜ Achievement Unlocked:<br>" + name;
  document.body.append(div);

  setTimeout(()=>div.remove(), 3000);
}

/* Save XP Data */
function saveXP(){
  localStorage.setItem('xpData', JSON.stringify(xpData));
}

/* Display XP + Level in Profile */
function updateProfileXP(){
  let bar = `
    <h3>Level: ${xpData.level}</h3>
    <div style='width:260px;height:20px;background:#333;border-radius:10px;overflow:hidden;'>
      <div style='width:${(xpData.xp/(xpData.level*100))*100}%;height:20px;background:#4caf50;'></div>
    </div>
    <p>${xpData.xp} / ${xpData.level * 100} XP</p>
  `;

  /* Insert XP bar into profile */
  setTimeout(()=>{
    let prof = document.getElementById("profile");
    if(prof){
      prof.innerHTML += bar;

      /* Achievements list */
      let ach = "<h3>Achievements</h3>";
      xpData.achievements.forEach(a=>{
        ach += `
        <div style='background:#222;padding:8px;border-radius:8px;margin:5px 0;'>
          üèÜ ${a}
        </div>`;
      });
      prof.innerHTML += ach;
    }
  }, 200);
}

/* Initialize XP in Profile */
updateProfileXP();


/* ===========================
   PHASE 5 - THEME ENGINE
=========================== */

let themes = JSON.parse(localStorage.getItem('themes') || "{}");
let currentTheme = localStorage.getItem("currentTheme") || "default";

/* Preset Themes */
const presetThemes = {
  "default": {bg:"#0f0f0f", bg2:"#1a1a1a", text:"#ffffff", accent:"#4caf50"},
  "vaporwave": {bg:"#2b004f", bg2:"#3b006f", text:"#ffb3ff", accent:"#ff00ff"},
  "midnight": {bg:"#000814", bg2:"#001d3d", text:"#e0e0e0", accent:"#1e90ff"},
  "forest": {bg:"#001f0f", bg2:"#00391c", text:"#c8ffc8", accent:"#00cc66"},
  "sunset": {bg:"#2a0000", bg2:"#4a0a0a", text:"#ffcccc", accent:"#ff5500"}
};

/* Apply Theme */
function applyTheme(name){
  let t = themes[name] || presetThemes[name];
  if(!t) return;

  document.documentElement.style.setProperty('--bg', t.bg);
  document.documentElement.style.setProperty('--bg2', t.bg2);
  document.documentElement.style.setProperty('--text', t.text);
  document.documentElement.style.setProperty('--accent', t.accent);

  currentTheme = name;
  localStorage.setItem("currentTheme", name);
}

/* Render Theme Panel */
function openThemePanel(){
  let html = "<h1>Themes</h1>";

  html += "<h3>Preset Themes</h3>";
  for(let k in presetThemes){
    html += \`
      <button onclick="applyTheme('\${k}')" 
        style='padding:10px;margin:5px;border:none;border-radius:8px;background:var(--accent);color:white;'>
        \${k}
      </button>
    \`;
  }

  html += "<h3>Create Custom Theme</h3>";
  html += \`
    <label>Background</label><br>
    <input id='custom_bg' type='color'><br><br>

    <label>Secondary Background</label><br>
    <input id='custom_bg2' type='color'><br><br>

    <label>Text Color</label><br>
    <input id='custom_text' type='color'><br><br>

    <label>Accent Color</label><br>
    <input id='custom_accent' type='color'><br><br>

    <button onclick="saveCustomTheme()" 
      style='padding:10px;border:none;background:#4caf50;color:white;border-radius:6px;'>
      Save Custom Theme
    </button>
  \`;

  document.getElementById("profile").innerHTML = html;
}

/* Save Custom Theme */
function saveCustomTheme(){
  let name = "custom";

  themes[name] = {
    bg: document.getElementById("custom_bg").value,
    bg2: document.getElementById("custom_bg2").value,
    text: document.getElementById("custom_text").value,
    accent: document.getElementById("custom_accent").value
  };

  localStorage.setItem("themes", JSON.stringify(themes));
  applyTheme(name);
  alert("Custom theme saved & applied!");
}

/* Add Theme Button to Sidebar */
document.getElementById("sidebar").innerHTML += `
  <div onclick="openThemePanel()">üé®</div>
`;

/* Auto-apply saved theme */
applyTheme(currentTheme);


/* ===========================
   PHASE 6 - GN-MATH GAME SCRAPER
=========================== */

/*
 NOTE:
 GN-Math.github.io does NOT provide a real API,
 so we scrape its repository index page using fetch + DOMParser.
 This works ONLY if GN-Math repo allows CORS. 
 If blocked, scraper will fail silently and fallback to built‚Äëin games.
*/

async function scrapeGNMath(){
  let url = "https://gn-math.github.io/";

  try{
    let res = await fetch(url, {mode:"cors"});
    let text = await res.text();

    let parser = new DOMParser();
    let doc = parser.parseFromString(text, "text/html");

    let links = [...doc.querySelectorAll("a")];

    let scraped = [];

    links.forEach(a=>{
      let name = a.innerText.trim();
      let href = a.href;

      if(href.endsWith("/") && name && !name.includes("..") && name.length < 30){
        scraped.push({
          name: name,
          img: "thumb_default.png",
          url: href,
          cat: "GN-Math"
        });
      }
    });

    if(scraped.length){
      games = games.concat(scraped);
      logActivity("Scraped", scraped.length + " GN-Math Games");
      renderGames(); 
      renderCategories();
    }

  }catch(e){
    console.log("GN-Math scraping failed:", e);
  }
}

/* Run scraper after load */
scrapeGNMath();


/* ===========================
   PHASE 7 - SEARCH + SORT SYSTEM
=========================== */

/* Inject Search + Sort UI */
function injectSearchSortUI(){
  let container = document.getElementById('games');
  let bar = `
    <div style='margin-bottom:15px;'>
      <input id="gameSearch" placeholder="Search games..." 
        style="padding:10px;width:250px;border-radius:10px;border:none;background:#222;color:white;">

      <select id="sortSelect" 
        style="padding:10px;border-radius:10px;background:#222;color:white;">
        <option value="none">Sort: None</option>
        <option value="az">A ‚Üí Z</option>
        <option value="za">Z ‚Üí A</option>
        <option value="fav">Favorites</option>
        <option value="recent">Recently Played</option>
      </select>
    </div>
  `;
  container.innerHTML = bar + container.innerHTML;
}
injectSearchSortUI();

/* APPLY SEARCH + SORT */
document.getElementById("gameSearch").addEventListener("input", ()=>{ renderGames(); });
document.getElementById("sortSelect").addEventListener("change", ()=>{ renderGames(); });

/* Override renderGames to include search + sort */
const oldRenderGames = renderGames;
renderGames = function(){
  let term = document.getElementById("gameSearch").value?.toLowerCase() || "";
  let sortType = document.getElementById("sortSelect").value;

  let list = [...games];

  /* Filter by search */
  list = list.filter(g => g.name.toLowerCase().includes(term));

  /* Sorting */
  if(sortType === "az") list.sort((a,b)=>a.name.localeCompare(b.name));
  if(sortType === "za") list.sort((a,b)=>b.name.localeCompare(a.name));
  if(sortType === "fav") list = list.filter(g => favorites.includes(g.name));
  if(sortType === "recent") list = list.filter(g => recent.includes(g.name));

  let html = "<h1>Games</h1>";

  list.forEach(g=>{
    let fav = favorites.includes(g.name) ? "fav" : "";
    html += `
      <div class='card' onclick="play(enc('${g.url}')); addRecent('${g.name}')">
        <div class="star ${fav}" onclick="toggleFav('${g.name}'); event.stopPropagation();">‚òÖ</div>
        <img src="${g.img}">
        <button>${g.name}</button>
      </div>`;
  });

  document.getElementById('games').innerHTML = 
    document.getElementById('games').innerHTML.split("</div>")[0] + "</div>" + html;

  injectSearchSortUI();
};

/* Initialize updated rendering */
renderGames();


/* ===========================
   PHASE 8 - UI ANIMATION OVERHAUL
=========================== */

/* Add CSS animations with JS injection */
const styleAnim = document.createElement("style");
styleAnim.innerHTML = `
/* Smooth fade-in for all sections */
.section {
  opacity: 0;
  transform: translateY(10px);
  transition: opacity .35s ease, transform .35s ease;
}
.section.active {
  opacity: 1;
  transform: translateY(0);
}

/* Card hover animation */
.card {
  transition: transform .25s ease, box-shadow .25s ease;
  box-shadow: 0 0 8px #0004;
}
.card:hover {
  transform: translateY(-8px) scale(1.06);
  box-shadow: 0 0 15px #0006;
}

/* Sidebar icon animation */
#sidebar div {
  transition: transform .2s ease, filter .2s ease;
}
#sidebar div:hover {
  transform: scale(1.25);
  filter: brightness(1.3);
}

/* Tab button animation */
.tabBtn {
  padding: 10px;
  background: #222;
  border: none;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  transition: background .2s ease, transform .2s ease;
}
.tabBtn:hover {
  background: var(--accent);
  transform: scale(1.05);
}

/* Smooth page transition */
#main {
  animation: fadeIn .4s ease;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Chat bubble animation */
#chatBox div {
  animation: chatPop .25s ease;
}
@keyframes chatPop {
  from { transform: scale(0.9); opacity:0; }
  to { transform: scale(1); opacity:1; }
}
`;
document.head.appendChild(styleAnim);

/* Mobile polish */
function applyMobileUI(){
  if(window.innerWidth < 600){
    document.querySelectorAll(".card").forEach(c=>{
      c.style.width = "140px";
      c.style.margin = "5px";
    });
  }
}
window.addEventListener("resize", applyMobileUI);
applyMobileUI();

/* Animated tab switching */
const oldSwitchTabUI = switchTab;
switchTab = function(code, tab){
  const box = document.getElementById("friendTabContent");
  box.style.opacity = 0;
  setTimeout(()=>{
    oldSwitchTabUI(code, tab);
    box.style.opacity = 1;
  }, 150);
};


/* ===========================
   PHASE 9 - NOTIFICATION SYSTEM
=========================== */

const notify = (msg, type="info") => {
  let box = document.createElement("div");
  box.style.position = "fixed";
  box.style.top = "20px";
  box.style.right = "20px";
  box.style.background = type === "error" ? "#c0392b" : type === "success" ? "#27ae60" : "#444";
  box.style.padding = "12px 18px";
  box.style.borderRadius = "10px";
  box.style.boxShadow = "0 0 10px #0007";
  box.style.color = "white";
  box.style.fontSize = "15px";
  box.style.opacity = "0";
  box.style.transition = "opacity .3s ease, transform .3s ease";
  box.innerHTML = msg;

  document.body.appendChild(box);

  setTimeout(() => {
    box.style.opacity = "1";
    box.style.transform = "translateY(5px)";
  }, 50);

  setTimeout(() => {
    box.style.opacity = "0";
    box.style.transform = "translateY(-10px)";
  }, 3000);

  setTimeout(() => box.remove(), 3500);
};

/* Notify on friend request */
const oldSendFriendReq = sendFriendRequest;
sendFriendRequest = function() {
  oldSendFriendReq();
  notify("Friend request sent!", "success");
};

/* Notify on accepting friend */
const oldAcceptReq = acceptReq;
acceptReq = function(code){
  oldAcceptReq(code);
  notify("Friend request accepted!", "success");
};

/* Notify on removing friend */
const oldRemoveFriend = removeFriend;
removeFriend = function(code){
  oldRemoveFriend(code);
  notify("Friend removed.", "error");
};

/* Notify on XP gain */
const oldGainXP = gainXP;
gainXP = function(amount){
  oldGainXP(amount);
  notify("+ " + amount + " XP gained!", "success");
};

/* Notify on new message */
const oldSendMsg = sendMessage;
sendMessage = function(code){
  oldSendMsg(code);
  notify("Message sent!", "info");
};

/* Notify on achievement unlock */
const oldUnlockAch = unlockAchievement;
unlockAchievement = function(name){
  oldUnlockAch(name);
  notify("üèÜ Achievement unlocked: " + name, "success");
};


/* ===========================
   PHASE 10 - GAME DETAILS PAGE
=========================== */

/* Create modal container */
let modal = document.createElement("div");
modal.id = "gameModal";
modal.style = `
  position: fixed;
  inset: 0;
  background: #000a;
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999999;
`;
modal.innerHTML = `
  <div id="modalBox" style="
    width: 420px;
    background: var(--bg2);
    padding: 20px;
    border-radius: 15px;
    color: var(--text);
    box-shadow: 0 0 20px #000;
    animation: fadeIn .3s ease;
  ">
    <img id="modalImg" src="" style="width:100%;border-radius:10px;">
    <h2 id="modalTitle"></h2>
    <p id="modalDesc" style="font-size:14px;opacity:.9;">No description available.</p>
    <p><b>XP Reward:</b> +20 XP per launch</p>
    <button id="playBtn" style="
      padding:10px;
      width:100%;
      border:none;
      border-radius:8px;
      margin-top:10px;
      background:var(--accent);
      color:white;
      font-size:16px;
    ">Play</button>
    <button onclick="closeGameModal()" style="
      padding:8px;
      width:100%;
      border:none;
      border-radius:8px;
      margin-top:10px;
      background:#333;
      color:white;
    ">Close</button>
  </div>
`;
document.body.appendChild(modal);

/* Open modal */
function openGameDetails(game){
  document.getElementById("modalImg").src = game.img;
  document.getElementById("modalTitle").innerText = game.name;
  document.getElementById("modalDesc").innerText = "Category: " + (game.cat || "None");

  document.getElementById("playBtn").onclick = () => {
    play(enc(game.url));
    addRecent(game.name);
    closeGameModal();
  };

  modal.style.display = "flex";
}

/* Close modal */
function closeGameModal(){
  modal.style.display = "none";
}

/* Override game card clicks to open modal instead of direct play */
const oldRenderGamesP10 = renderGames;
renderGames = function(){
  oldRenderGamesP10();

  document.querySelectorAll('.card').forEach((c, i) => {
    let gname = c.querySelector("button")?.innerText;
    let g = games.find(x => x.name === gname);

    if(g){
      c.onclick = () => openGameDetails(g);
    }
  });
};
renderGames();


/* ===========================
   PHASE 11 ‚Äì SETTINGS SYSTEM
=========================== */

let settings = JSON.parse(localStorage.getItem("settings") || `{
  "animations": true,
  "sounds": true,
  "performance": false
}`);

/* Sidebar button */
document.getElementById("sidebar").innerHTML += `
  <div onclick="openSettings()">‚öôÔ∏è</div>
`;

/* Render Settings Page */
function openSettings() {
  let html = `
    <h1>Settings</h1>

    <h3>Profile</h3>
    <input id="set_username" placeholder="Username" value="${profile.username || ''}"
      style="padding:10px;width:260px;border-radius:10px;background:#222;color:white;border:none;"><br><br>
    <button onclick="saveUsername()" 
      style="padding:10px;border:none;border-radius:8px;background:var(--accent);color:white;">
      Save Username
    </button>

    <h3 style="margin-top:20px;">Appearance</h3>
    <label>
      <input type="checkbox" id="toggleAnimations" ${settings.animations ? "checked" : ""}>
      Enable animations
    </label><br>
    <label>
      <input type="checkbox" id="toggleSounds" ${settings.sounds ? "checked" : ""}>
      Enable sound effects
    </label><br>
    <label>
      <input type="checkbox" id="togglePerformance" ${settings.performance ? "checked" : ""}>
      High-performance mode (disables effects)
    </label><br><br>

    <button onclick="saveSettings()" 
      style="padding:10px;border:none;border-radius:8px;background:var(--accent);color:white;">
      Save Settings
    </button>

    <h3 style="margin-top:30px;">Storage</h3>
    <button onclick="resetSME()" 
      style="padding:10px;border:none;border-radius:8px;background:#c0392b;color:white;">
      Reset all SME data
    </button>
  `;

  document.getElementById("profile").innerHTML = html;
}

/* Save Username */
function saveUsername() {
  let val = document.getElementById("set_username").value;
  profile.username = val;
  localStorage.setItem("profile", JSON.stringify(profile));
  notify("Username updated!", "success");
}

/* Save Settings */
function saveSettings() {
  settings.animations = document.getElementById("toggleAnimations").checked;
  settings.sounds = document.getElementById("toggleSounds").checked;
  settings.performance = document.getElementById("togglePerformance").checked;

  localStorage.setItem("settings", JSON.stringify(settings));

  notify("Settings saved!", "success");

  /* Apply performance mode */
  if (settings.performance) {
    document.body.style.transition = "none";
  } else {
    document.body.style.transition = "0.3s";
  }
}

/* Reset All SME Data */
function resetSME() {
  if (!confirm("Are you sure? This will delete EVERYTHING.")) return;
  localStorage.clear();
  notify("SME data reset. Reloading...", "error");
  setTimeout(() => location.reload(), 1200);
}


/* ===========================
   PHASE 12 ‚Äì SOUND EFFECTS SYSTEM
=========================== */

/* Preload sounds */
const smeSounds = {
  click: new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"),
  hover: new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg"),
  message: new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"),
  achievement: new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"),
  notify: new Audio("https://actions.google.com/sounds/v1/cartoon/slide_whistle_to_drum_hit.ogg")
};

/* Set volume */
for (let s in smeSounds) smeSounds[s].volume = 0.4;

/* Play sound only if enabled */
function playSound(type){
  if(!settings.sounds) return;
  if(smeSounds[type]) smeSounds[type].play();
}

/* Add click sound to all buttons */
document.addEventListener("click", e=>{
  if(e.target.tagName === "BUTTON" || e.target.classList.contains("tabBtn")){
    playSound("click");
  }
});

/* Add hover sound to sidebar icons + cards */
document.addEventListener("mouseover", e=>{
  if(e.target.closest("#sidebar div") || e.target.closest(".card")){
    playSound("hover");
  }
});

/* Message sent sound */
const oldSendMsgP12 = sendMessage;
sendMessage = function(code){
  oldSendMsgP12(code);
  playSound("message");
};

/* Achievement unlock sound */
const oldUnlockP12 = unlockAchievement;
unlockAchievement = function(name){
  oldUnlockP12(name);
  playSound("achievement");
};

/* Notification sound */
const oldNotifyP12 = notify;
notify = function(msg, type){
  oldNotifyP12(msg, type);
  playSound("notify");
};


/* ===========================
   PHASE 14 ‚Äì ANIMATED BACKGROUND THEMES
=========================== */

/*
   Adds 3 animated theme backgrounds:
   1. Matrix Rain
   2. Particle Stars
   3. Vaporwave Grid
*/

document.getElementById("sidebar").innerHTML += `
  <div onclick="openBackgroundThemes()">üåÄ</div>
`;

/* Panel */
function openBackgroundThemes(){
  document.getElementById("profile").innerHTML = `
    <h1>Animated Backgrounds</h1>

    <button onclick="setBG('none')" style="padding:10px;width:260px;border:none;border-radius:8px;background:#333;color:white;">Disable Background</button><br><br>

    <button onclick="setBG('matrix')" style="padding:10px;width:260px;border:none;border-radius:8px;background:var(--accent);color:white;">Matrix Rain</button><br><br>

    <button onclick="setBG('stars')" style="padding:10px;width:260px;border:none;border-radius:8px;background:var(--accent);color:white;">Particle Stars</button><br><br>

    <button onclick="setBG('vaporwave')" style="padding:10px;width:260px;border:none;border-radius:8px;background:var(--accent);color:white;">Vaporwave Grid</button><br><br>
  `;
}

/* Canvas for animations */
let bgCanvas = document.createElement("canvas");
bgCanvas.id = "bgAnim";
bgCanvas.style = "position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;";
document.body.appendChild(bgCanvas);

let ctx = bgCanvas.getContext("2d");
let currentBG = localStorage.getItem("bgTheme") || "none";

/* Resize listener */
function resizeBG(){
  bgCanvas.width = window.innerWidth;
  bgCanvas.height = window.innerHeight;
}
resizeBG();
window.addEventListener("resize", resizeBG);

/* Apply background */
function setBG(type){
  currentBG = type;
  localStorage.setItem("bgTheme", type);
  notify("Background updated!", "success");
}

/* MATRIX RAIN */
let matrixChars = "„Ç¢„Ç°„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É©„ÉØ0123456789";
let matrixDrops = [];

/* STARS */
let stars = [];

/* VAPORWAVE GRID */
let gridOffset = 0;

/* Animation loop */
function animateBG(){
  requestAnimationFrame(animateBG);

  ctx.clearRect(0,0,bgCanvas.width,bgCanvas.height);

  if(currentBG === "matrix"){
    if(matrixDrops.length === 0){
      let columns = Math.floor(bgCanvas.width / 20);
      matrixDrops = Array(columns).fill(0);
    }

    ctx.fillStyle = "rgba(0,0,0,0.05)";
    ctx.fillRect(0,0,bgCanvas.width,bgCanvas.height);

    ctx.fillStyle = "#00ff55";
    ctx.font = "16px monospace";

    matrixDrops.forEach((y, i)=>{
      let text = matrixChars[Math.floor(Math.random()*matrixChars.length)];
      ctx.fillText(text, i*20, y*20);

      if(y*20 > bgCanvas.height && Math.random() > 0.975){
        matrixDrops[i] = 0;
      }
      matrixDrops[i]++;
    });
  }

  if(currentBG === "stars"){
    if(stars.length === 0){
      for(let i=0;i<200;i++){
        stars.push({x:Math.random()*bgCanvas.width, y:Math.random()*bgCanvas.height, size:Math.random()*2});
      }
    }
    ctx.fillStyle = "white";
    stars.forEach(s=>{
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
      ctx.fill();
    });
  }

  if(currentBG === "vaporwave"){
    gridOffset += 0.03;

    ctx.strokeStyle = "#ff00ff";
    ctx.lineWidth = 1;

    for(let y=0; y<bgCanvas.height; y+=40){
      ctx.beginPath();
      ctx.moveTo(0, y + (gridOffset*10)%40);
      ctx.lineTo(bgCanvas.width, y + (gridOffset*10)%40);
      ctx.stroke();
    }

    for(let x=0; x<bgCanvas.width; x+=40){
      ctx.beginPath();
      ctx.moveTo(x + (gridOffset*10)%40, 0);
      ctx.lineTo(x + (gridOffset*10)%40, bgCanvas.height);
      ctx.stroke();
    }
  }
}

animateBG();


/* ===========================
   PHASE 15 ‚Äì CUSTOM ANIMATED BACKGROUND CREATOR
=========================== */

/* Sidebar icon */
document.getElementById("sidebar").innerHTML += `
  <div onclick="openCustomBGCreator()">‚ú®</div>
`;

/* Panel UI */
function openCustomBGCreator(){
  document.getElementById("profile").innerHTML = `
    <h1>Create Custom Animated Background</h1>

    <p>Choose color:</p>
    <input type="color" id="cbg_color" value="#ff00ff"><br><br>

    <p>Particle count:</p>
    <input type="number" id="cbg_count" min="10" max="500" value="100"
      style="padding:8px;border:none;border-radius:8px;background:#222;color:white;"><br><br>

    <p>Particle speed:</p>
    <input type="range" id="cbg_speed" min="1" max="10" value="3"><br><br>

    <button onclick="applyCustomBG()" 
      style="padding:10px;border:none;border-radius:8px;background:var(--accent);color:white;">
      Apply Background
    </button>
  `;
}

/* Data */
let customParticles = [];
let customBGEnabled = false;

/* Apply */
function applyCustomBG(){
  customBGEnabled = true;
  localStorage.setItem("customBG", "true");
  localStorage.setItem("customBG_color", document.getElementById("cbg_color").value);
  localStorage.setItem("customBG_count", document.getElementById("cbg_count").value);
  localStorage.setItem("customBG_speed", document.getElementById("cbg_speed").value);

  notify("Custom animated background applied!", "success");

  initCustomParticles();
}

/* Init particle field */
function initCustomParticles(){
  customParticles = [];
  let count = parseInt(localStorage.getItem("customBG_count") || "100");

  for(let i=0;i<count;i++){
    customParticles.push({
      x: Math.random()*bgCanvas.width,
      y: Math.random()*bgCanvas.height,
      size: Math.random()*3 + 1,
      dx: (Math.random()-0.5) * (localStorage.getItem("customBG_speed") || 3),
      dy: (Math.random()-0.5) * (localStorage.getItem("customBG_speed") || 3)
    });
  }
}

/* Integrate into animation loop */
const oldAnim = animateBG;
animateBG = function(){
  oldAnim();

  if(customBGEnabled){
    let color = localStorage.getItem("customBG_color") || "#ff00ff";
    ctx.fillStyle = color;

    customParticles.forEach(p=>{
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
      ctx.fill();

      p.x += p.dx;
      p.y += p.dy;

      if(p.x < 0 || p.x > bgCanvas.width) p.dx *= -1;
      if(p.y < 0 || p.y > bgCanvas.height) p.dy *= -1;
    });
  }
};

/* Load custom BG if active */
if(localStorage.getItem("customBG") === "true"){
  customBGEnabled = true;
  initCustomParticles();
}


/* ===========================
   PHASE 17 ‚Äì GAME PLAYTIME TRACKING
=========================== */

let playtime = JSON.parse(localStorage.getItem("playtime") || "{}");
let activeGame = null;
let activeStart = null;

/* Start timer when game launches */
function startPlayTimer(gameName){
  activeGame = gameName;
  activeStart = Date.now();
}

/* Stop timer when ESC closes game */
function stopPlayTimer(){
  if(!activeGame || !activeStart) return;

  let mins = Math.round((Date.now() - activeStart) / 60000);

  if(!playtime[activeGame]){
    playtime[activeGame] = { totalMinutes: 0, sessions: 0, lastPlayed: "" };
  }

  playtime[activeGame].totalMinutes += mins;
  playtime[activeGame].sessions++;
  playtime[activeGame].lastPlayed = new Date().toLocaleString();

  localStorage.setItem("playtime", JSON.stringify(playtime));

  logActivity("Played Game", activeGame + " (+" + mins + " min)");

  activeGame = null;
  activeStart = null;
}

/* Patch play() to start timer */
const oldPlayP17 = play;
play = function(url){
  let g = games.find(x => enc(x.url) === url);
  if(g){
    startPlayTimer(g.name);
  }
  oldPlayP17(url);
};

/* Patch ESC handler to stop timer */
document.addEventListener('keydown', e=>{
  if(e.key === "Escape"){
    stopPlayTimer();
  }
});

/* Show playtime in game modal */
const oldOpenDetailsP17 = openGameDetails;
openGameDetails = function(game){
  oldOpenDetailsP17(game);

  let box = document.getElementById("modalBox");

  let data = playtime[game.name] || { totalMinutes: 0, sessions: 0, lastPlayed: "Never" };
  let hours = (data.totalMinutes / 60).toFixed(1);

  box.innerHTML += `
    <h3>Playtime</h3>
    <p><b>Total:</b> ${hours} hours (${data.totalMinutes} minutes)</p>
    <p><b>Sessions:</b> ${data.sessions}</p>
    <p><b>Last Played:</b> ${data.lastPlayed}</p>
  `;
};


/* ===========================
   PHASE 16 ‚Äì CUSTOM STATUS + RICH PRESENCE
=========================== */

let statusData = JSON.parse(localStorage.getItem("statusData") || `{
  "customStatus": "Available",
  "rich": ""
}`);

/* Add "Status" button to sidebar */
document.getElementById("sidebar").innerHTML += `
  <div onclick="openStatusMenu()">üí¨</div>
`;

/* Render Status Menu */
function openStatusMenu(){
  document.getElementById("profile").innerHTML = `
    <h1>Status Settings</h1>

    <h3>Custom Status</h3>
    <input id="customStatusInput" placeholder="Enter custom status..." 
      value="${statusData.customStatus}" 
      style="padding:10px;width:260px;border-radius:10px;background:#222;border:none;color:white;"><br><br>

    <button onclick="saveCustomStatus()" 
      style="padding:10px;border:none;border-radius:8px;background:var(--accent);color:white;">
      Save Status
    </button>

    <h3 style="margin-top:25px;">Rich Presence</h3>
    <p style="opacity:.7;">Automatically shows what you're doing (playing, browsing, editing).</p>
  `;
}

/* Save Custom Status */
function saveCustomStatus(){
  statusData.customStatus = document.getElementById("customStatusInput").value;
  localStorage.setItem("statusData", JSON.stringify(statusData));
  notify("Custom status updated!", "success");
}

/* Update Rich Presence */
function updateRichPresence(text){
  statusData.rich = text;
  localStorage.setItem("statusData", JSON.stringify(statusData));
}

/* Patch game launch to update rich presence */
const oldPlayP16 = play;
play = function(url){
  let g = games.find(x => enc(x.url) === url);
  if(g){
    updateRichPresence("Playing " + g.name);
  }
  oldPlayP16(url);
};

/* Patch ESC key to revert rich presence */
document.addEventListener("keydown", e=>{
  if(e.key === "Escape"){
    updateRichPresence("");
  }
});

/* Show status on Profile Page */
const oldRenderProfileP16 = renderProfile;
renderProfile = function(){
  oldRenderProfileP16();

  let box = document.getElementById("profile");
  box.innerHTML += `
    <h3>Status Message</h3>
    <p><b>Custom:</b> ${statusData.customStatus}</p>
    <p><b>Rich Presence:</b> ${statusData.rich || "None"}</p>
  `;
};

/* Show status in Friend List */
const oldLoadFriendsP16 = loadFriends;
loadFriends = function(){
  oldLoadFriendsP16();

  friends.forEach(code=>{
    let card = [...document.querySelectorAll(".friendCard")].find(x=>x.innerText.includes(code));
    if(card){
      card.innerHTML += `
        <div style='font-size:12px;opacity:.8;'>Status: ${statusData.customStatus}</div>
        <div style='font-size:11px;color:var(--accent);'>${statusData.rich}</div>
      `;
    }
  });
};

/* Show status in Friend Profile Tabs */
const oldOpenFriendP16 = openFriend;
openFriend = function(code){
  oldOpenFriendP16(code);

  document.getElementById("friendTabContent").innerHTML += `
    <h3>Status</h3>
    <p><b>Custom:</b> ${statusData.customStatus}</p>
    <p><b>Rich Presence:</b> ${statusData.rich || "None"}</p>
  `;
};


/* ===========================
   PHASE 18 ‚Äì FULL RICH PRESENCE EXPANSION
=========================== */

/*
   Adds automatic presence states:
   - Browsing Games
   - Viewing Game Details
   - Editing Profile
   - In Settings
   - Idle (AFK)
*/

let presenceTimeout = null;

/* Update activity */
function setPresence(state){
  statusData.rich = state;
  localStorage.setItem("statusData", JSON.stringify(statusData));
}

/* Idle detection */
let lastMove = Date.now();
document.addEventListener("mousemove", ()=> lastMove = Date.now());
document.addEventListener("keydown", ()=> lastMove = Date.now());

setInterval(()=>{
  if(Date.now() - lastMove > 180000){  // 3 minutes idle
    setPresence("Idle");
  }
}, 30000);

/* Patch navigation functions */
const oldRenderGamesP18 = renderGames;
renderGames = function(){
  setPresence("Browsing Games");
  oldRenderGamesP18();
};

const oldOpenGameDetailsP18 = openGameDetails;
openGameDetails = function(game){
  setPresence("Viewing Details: " + game.name);
  oldOpenGameDetailsP18(game);
};

const oldRenderProfileP18 = renderProfile;
renderProfile = function(){
  setPresence("Editing Profile");
  oldRenderProfileP18();
};

function openSettings(){
  setPresence("In Settings");
  // settings UI already defined in Phase 11
}

/* Refresh friends list Rich Presence display */
const oldLoadFriendsP18 = loadFriends;
loadFriends = function(){
  oldLoadFriendsP18();

  friends.forEach(code=>{
    let card = [...document.querySelectorAll(".friendCard")].find(x=>x.innerText.includes(code));
    if(card){
      card.innerHTML += `
        <div style='font-size:11px;color:var(--accent);opacity:.9;'>${statusData.rich}</div>
      `;
    }
  });
};

/* Friend profile display */
const oldOpenFriendP18 = openFriend;
openFriend = function(code){
  oldOpenFriendP18(code);

  document.getElementById("friendTabContent").innerHTML += `
    <h3>Presence</h3>
    <p>${statusData.rich || "None"}</p>
  `;
};


/* ===========================
   PHASE 20 ‚Äì SOFT FADE + SLIDE TRANSITIONS (DISCORD STYLE)
=========================== */

/* Create transition style */
const styleTrans = document.createElement("style");
styleTrans.innerHTML = `
.fadeSlide {
  opacity: 0;
  transform: translateY(8px);
  transition: opacity .25s ease, transform .25s ease;
}
.fadeSlide.show {
  opacity: 1;
  transform: translateY(0);
}
.modalPop {
  animation: modalPop .25s ease;
}
@keyframes modalPop {
  from { transform: scale(.92); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
`;
document.head.appendChild(styleTrans);

/* Transition wrapper */
function smoothSwap(element, callback){
  if(!settings.animations){
    callback();
    return;
  }
  element.classList.remove("show");
  setTimeout(()=>{
    callback();
    setTimeout(()=>element.classList.add("show"), 20);
  }, 200);
}

/* PATCH MAIN SECTIONS */
function applyTransitions(){
  document.querySelectorAll(".section, #profile, #games").forEach(sec=>{
    sec.classList.add("fadeSlide","show");
  });
}
applyTransitions();

/* Patch render functions */
const oldRenderGamesP20 = renderGames;
renderGames = function(){
  let sec = document.getElementById("games");
  smoothSwap(sec, ()=> oldRenderGamesP20());
};

const oldRenderProfileP20 = renderProfile;
renderProfile = function(){
  let sec = document.getElementById("profile");
  smoothSwap(sec, ()=> oldRenderProfileP20());
};

const oldOpenFriendP20 = openFriend;
openFriend = function(code){
  let cont = document.getElementById("friendTabContent");
  smoothSwap(cont, ()=> oldOpenFriendP20(code));
};

/* Modal pop */
const oldOpenDetailsP20 = openGameDetails;
openGameDetails = function(g){
  oldOpenDetailsP20(g);
  document.getElementById("modalBox").classList.add("modalPop");
  setTimeout(()=>document.getElementById("modalBox").classList.remove("modalPop"),300);
};


/* ===========================
   PHASE 21 ‚Äì CHAT ENGINE
=========================== */

let currentChannel = "general";
let chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "{}");

function saveChat(){
  localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
}

/* Open Chat Page */
function openChatPage(){
  document.getElementById("games").style.display = "none";
  document.getElementById("profile").style.display = "none";
  document.getElementById("friends").style.display = "none";
  document.getElementById("settings").style.display = "none";
  document.getElementById("chatPage").style.display = "block";
  openChannel(currentChannel);
}

/* Channel switching */
function openChannel(name){
  currentChannel = name;

  document.getElementById("chatInput").placeholder = "Message #" + name;

  let log = document.getElementById("chatLog");
  log.innerHTML = "";

  if(!chatHistory[name]) chatHistory[name] = [];

  chatHistory[name].forEach(msg=>{
    log.innerHTML += formatMessage(msg);
  });

  log.scrollTop = log.scrollHeight;
}

/* Sending messages */
function sendChannelMessage(){
  let input = document.getElementById("chatInput");
  let text = input.value.trim();
  if(text.length === 0) return;

  let msg = {
    user: profile.username || "You",
    text: text,
    time: new Date().toLocaleTimeString(),
    presence: statusData.rich || statusData.customStatus
  };

  chatHistory[currentChannel].push(msg);
  saveChat();

  document.getElementById("chatLog").innerHTML += formatMessage(msg);
  document.getElementById("chatLog").scrollTop = document.getElementById("chatLog").scrollHeight;

  input.value = "";
  playSound("message");
}

/* Format message bubble */
function formatMessage(msg){
  return `
    <div style="margin-bottom:10px;">
      <b style="color:#7289da;">${msg.user}</b>
      <span style="opacity:.6;font-size:12px;">${msg.time}</span>
      <div style="margin-left:10px;">${msg.text}</div>
      <div style="margin-left:10px;font-size:11px;color:#a0a0a0;">${msg.presence || ""}</div>
    </div>
  `;
}


/* ===========================
   PHASE 22 ‚Äì GAME UPDATE CHECK ENGINE
=========================== */

let updateConfig = JSON.parse(localStorage.getItem("updateConfig") || `{
  "interval": 0,
  "customInterval": 5,
  "lastCheck": "Never"
}`);

let lastGameList = JSON.parse(localStorage.getItem("lastGameList") || "[]");

/* OPEN SETTINGS TABS */
function openSettings(){
  document.getElementById("games").style.display = "none";
  document.getElementById("profile").style.display = "none";
  document.getElementById("friends").style.display = "none";
  document.getElementById("chatPage").style.display = "none";
  document.getElementById("settingsPage").style.display = "block";

  openSetTab("general");
}

function openSetTab(tab){
  const box = document.getElementById("settingsContent");
  document.querySelectorAll(".setTab").forEach(t=>t.style.background="transparent");
  let active = [...document.querySelectorAll(".setTab")].find(t=>t.innerText.toLowerCase()==tab);
  if(active) active.style.background="#333";

  if(tab === "updates"){
    box.innerHTML = `
      <h2>Game Updates</h2>

      <p>Select how often SME checks for new games:</p>

      <label><input type="radio" name="upint" value="0" ${updateConfig.interval==0?"checked":""}> Off</label><br>
      <label><input type="radio" name="upint" value="1" ${updateConfig.interval==1?"checked":""}> Every 1 min</label><br>
      <label><input type="radio" name="upint" value="2" ${updateConfig.interval==2?"checked":""}> Every 2 min</label><br>
      <label><input type="radio" name="upint" value="5" ${updateConfig.interval==5?"checked":""}> Every 5 min</label><br>
      <label><input type="radio" name="upint" value="10" ${updateConfig.interval==10?"checked":""}> Every 10 min</label><br>

      <label>
        <input type="radio" name="upint" value="custom" ${updateConfig.interval=="custom"?"checked":""}> Custom:
      </label>
      <input id="customUpInt" type="number" value="${updateConfig.customInterval}" min="1" 
        style="width:60px;padding:3px;background:#222;color:white;border:none;border-radius:6px;">
      <br><br>

      <button onclick="saveUpdateSettings()" 
        style="padding:10px;border:none;border-radius:8px;background:var(--accent);color:white;">
        Save Settings
      </button>

      <h3 style="margin-top:20px;">Manual Check</h3>
      <button onclick="manualCheckUpdates()" 
        style="padding:10px;border:none;border-radius:8px;background:#444;color:white;">
        Check for updates now
      </button>

      <p style="margin-top:10px;opacity:.7;">Last checked: ${updateConfig.lastCheck}</p>
    `;
  }

  if(tab === "general"){
    box.innerHTML = `<h2>General Settings</h2><p>Coming soon.</p>`;
  }

  if(tab === "appearance"){
    box.innerHTML = `<h2>Appearance</h2><p>Appearance options are in profile.</p>`;
  }

  if(tab === "storage"){
    box.innerHTML = `<h2>Storage Options</h2><p>Clear data in older settings panel.</p>`;
  }
}

/* SAVE SETTINGS */
function saveUpdateSettings(){
  let val = [...document.querySelectorAll("input[name='upint']")].find(x=>x.checked).value;
  updateConfig.interval = val=="custom" ? "custom" : Number(val);
  updateConfig.customInterval = Number(document.getElementById("customUpInt").value);

  localStorage.setItem("updateConfig", JSON.stringify(updateConfig));
  notify("Update settings saved!", "success");

  setupAutoChecker();
}

/* MANUAL CHECK */
function manualCheckUpdates(){
  runUpdateCheck(true);
}

/* AUTO CHECK ENGINE */
let autoChecker = null;

function setupAutoChecker(){
  if(autoChecker) clearInterval(autoChecker);

  let mins = 0;

  if(updateConfig.interval === 0) return;
  if(updateConfig.interval === "custom"){
    mins = updateConfig.customInterval;
  } else {
    mins = updateConfig.interval;
  }

  autoChecker = setInterval(()=>runUpdateCheck(false), mins * 60000);
}

/* RUN UPDATE CHECK */
function runUpdateCheck(manual){
  // scraper should populate 'games' list
  let newList = games.map(g=>g.name);

  let newGames = newList.filter(g=>!lastGameList.includes(g));

  updateConfig.lastCheck = new Date().toLocaleTimeString();
  localStorage.setItem("updateConfig", JSON.stringify(updateConfig));

  if(newGames.length > 0){
    notify(`üÜï ${newGames.length} new game(s) detected!`, "success");

    lastGameList = newList;
    localStorage.setItem("lastGameList", JSON.stringify(lastGameList));
  } else if(manual){
    notify("No new games found.", "info");
  }
}

setupAutoChecker(); 

</script>


<!-- PHASE 21 CHAT PAGE -->
<div id="chatPage" class="section fadeSlide" style="display:none;">
  <div style="display:flex;height:100%;">

    <!-- CHANNEL SIDEBAR -->
    <div id="chatChannels" style="
      width:180px;
      background:#2f3136;
      padding:10px;
      color:white;
      border-right:2px solid #202225;
      overflow-y:auto;
    ">
      <h3 style="opacity:.7;margin-bottom:5px;">CHANNELS</h3>
      <div class="chatChan" onclick="openChannel('general')"># general</div>
      <div class="chatChan" onclick="openChannel('gaming')"># gaming</div>
      <div class="chatChan" onclick="openChannel('random')"># random</div>
      <div class="chatChan" onclick="openChannel('help')"># help</div>
      <div class="chatChan" onclick="openChannel('memes')"># memes</div>

      <h3 style="opacity:.7;margin:10px 0 5px;">FRIEND ROOMS</h3>
      <div class="chatChan" onclick="openChannel('friends_online')">Friends Online</div>
      <div class="chatChan" onclick="openChannel('close_friends')">Close Friends</div>
      <div class="chatChan" onclick="openChannel('all_friends')">All Friends</div>
    </div>

    <!-- MESSAGE AREA -->
    <div id="chatMessages" style="
      flex:1;
      display:flex;
      flex-direction:column;
      background:#36393f;
      color:white;
    ">
      <div id="chatLog" style="flex:1;padding:15px;overflow-y:auto;font-size:15px;"></div>

      <div style="padding:10px;border-top:2px solid #2f3136;">
        <textarea id="chatInput" 
          placeholder="Message #general"
          style="width:100%;height:60px;background:#40444b;color:white;border:none;border-radius:8px;padding:10px;resize:none;"></textarea>
        <button onclick="sendChannelMessage()" style="
          width:100%;margin-top:8px;padding:10px;border:none;
          background:var(--accent);color:white;border-radius:8px;">
          Send
        </button>
      </div>
    </div>

  </div>
</div>


<!-- PHASE 22 SETTINGS TABS -->
<div id="settingsPage" class="section fadeSlide" style="display:none;">
  <div style="display:flex;height:100%;">

    <!-- LEFT TAB BAR -->
    <div id="settingsTabs" style="
      width:160px;
      background:#222;
      padding:10px;
      color:white;
      border-right:2px solid #111;
      display:flex;
      flex-direction:column;
      gap:10px;
    ">
      <div class="setTab" onclick="openSetTab('general')">General</div>
      <div class="setTab" onclick="openSetTab('appearance')">Appearance</div>
      <div class="setTab" onclick="openSetTab('updates')">Updates</div>
      <div class="setTab" onclick="openSetTab('storage')">Storage</div>
    </div>

    <!-- RIGHT PANE -->
    <div id="settingsContent" style="
      flex:1;
      padding:20px;
      overflow-y:auto;
      color:white;
    ">
      <!-- Content inserted dynamically -->
    </div>

  </div>
</div>

</body>
</html>
